SELECT 
	FILIAL, 
	COALESCE([01],0) JANEIRO,
	COALESCE([02],0) FEVEREIRO,
	COALESCE([03],0) MARÇO,
	COALESCE([04],0) ABRIL,
	COALESCE([05],0) MAIO,
	COALESCE([06],0) JUNHO,
	COALESCE([07],0) JULHO,
	COALESCE([08],0) AGOSTO,
	COALESCE([09],0) SETEMBRO,
	COALESCE([10],0) OUTUBRO,
	COALESCE([11],0) NOVEMBRO,
	COALESCE([12],0) DEZEMBRO
FROM 
(
	SELECT  
		F1_FILIAL FILIAL, 
		SUBSTRING(F1_EMISSAO,5,2) MES,
		F1_VALBRUT VALOR
	 FROM 
		SF1040 F1 
		 LEFT JOIN DHI040 DHI ON DHI_CODIGO = F1_MOTRET AND DHI.D_E_L_E_T_ = '' 
		 INNER JOIN SD1040 D1 ON D1_FILIAL = F1_FILIAL AND D1_DOC = F1_DOC AND D1_SERIE = F1_SERIE AND D1_FORNECE = F1_FORNECE AND D1_LOJA = F1_LOJA AND D1.D_E_L_E_T_ = '' 
		 INNER JOIN SF2040 F2 ON F2_DOC = D1_NFORI AND F2_SERIE = D1_SERIORI AND F2_FILIAL = D1_FILORI AND F2.D_E_L_E_T_ = '' /*AND F2_CLIENTE NOT IN ("+cCliDen+")*/ 
		 INNER JOIN SA1040 A1 ON F2_CLIENTE = A1_COD AND F2_LOJA = A1_LOJA AND A1.D_E_L_E_T_ = '' 
		 INNER JOIN SA3040 A3 ON A3_COD = F2_VEND1 AND A3.D_E_L_E_T_ = '' 
	 WHERE 
		F1_FILIAL = '0404' 
		AND F1_TIPO = 'D' 
		AND F1_EMISSAO BETWEEN '20220101' AND '20220801' 
		AND F1.D_E_L_E_T_ = '' 
		AND F1_DUPL <> '' 
	GROUP BY F1_FILIAL, F1_DOC, F1_SERIE, F2_CLIENTE, F2_LOJA, A1_NOME, SUBSTRING(F1_EMISSAO,5,2), F1_VALBRUT, A3_NOME, F1_MOTRET, DHI_DESCRI, ISNULL(CONVERT(VARCHAR(2047), CONVERT(VARBINARY(2047), F1_HISTRET)),'') 
	
)CREDIT_NOTES
	PIVOT ( SUM( VALOR) FOR MES IN([01],[02],[03],[04],[05],[06],[07],[08],[09],[10],[11],[12]) )  TOTAL_CREDITS
--ORDER BY 7 


