SELECT 
	PRODUTO_01,
	LOTECTL_01,
	LOCAL_01,
	DTVALID_01,
	PRODUTO_02,
	LOTECTL_02,
	LOCAL_02,
	DTVALID_02
	--INTO #TT1
FROM 
(
	SELECT 
		B8.B8_PRODUTO PRODUTO_01,
		B8.B8_LOTECTL LOTECTL_01,
		B8.B8_LOCAL LOCAL_01,
		B8.B8_DTVALID DTVALID_01,
		B8X.B8_PRODUTO PRODUTO_02,
		B8X.B8_LOTECTL LOTECTL_02,
		B8X.B8_LOCAL LOCAL_02,
		B8X.B8_DTVALID DTVALID_02
	FROM 
		SB8040 B8 
		INNER JOIN SB8040 B8X ON B8X.B8_FILIAL = B8.B8_FILIAL AND B8X.B8_PRODUTO = B8.B8_PRODUTO AND B8X.B8_LOTECTL = B8.B8_LOTECTL AND B8X.B8_LOCAL = '01' AND B8X.D_E_L_E_T_ = ''
	WHERE
		B8.B8_FILIAL = '0401' AND 
		B8.B8_LOCAL = '80' AND 
		B8.B8_SALDO > 0 AND 
		B8.D_E_L_E_T_ = ''
) DIFF_DTVALID
WHERE DTVALID_01 <> DTVALID_02

/*
BEGIN TRANSACTION 
	UPDATE SB8040 SET B8_DTVALID = DTVALID_02
	--SELECT 
	--	B8_PRODUTO,
	--	B8_LOTECTL,
	--	B8_DTVALID 
	FROM 
		SB8040 
		INNER JOIN #TT1 ON PRODUTO_01 = B8_PRODUTO AND LOCAL_01 = B8_LOCAL AND LOTECTL_01 = B8_LOTECTL 

ROLLBACK

COMMIT
*/