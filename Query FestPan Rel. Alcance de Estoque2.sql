SELECT MONTH(SF2.F2_EMISSAO) AS MES_MOV,YEAR(SF2.F2_EMISSAO) AS ANO_MOV,
SUM(SD2.D2_QUANT) AS QTDITEM,SB1.B1_COD,SA1.A1_COD,SB2.B2_LOCAL,
AVG(SB2.B2_QATU - SB2.B2_RESERVA - SB2.B2_QACLASS - SB2.B2_QEMPSA - SB2.B2_QTNP - SB2.B2_QEMPN + SB2.B2_QNPT) AS ESTOQUE
FROM 
SF2010 SF2
INNER JOIN SA1010 SA1 ON SA1.A1_COD BETWEEN '00037' AND '00037' AND 
SA1.D_E_L_E_T_ <> '*' 
INNER JOIN SB1010 SB1 ON SB1.B1_COD BETWEEN ' ' AND 'ZZZZZZZZZZZZZZZ' AND 
SB1.D_E_L_E_T_ <> '*'  
INNER JOIN SD2010 SD2 ON SD2.D2_FILIAL = SF2.F2_FILIAL AND 
SD2.D2_DOC + SD2.D2_SERIE = SF2.F2_DOC + SF2.F2_SERIE AND 
SD2.D2_TES <> '502' AND SD2.D2_COD = SB1.B1_COD AND 
SD2.D_E_L_E_T_ <> '*'
INNER JOIN SB2010 SB2 ON SB2.B2_FILIAL = SF2.F2_FILIAL AND 
SB2.B2_COD = SD2.D2_COD AND SB2.B2_LOCAL BETWEEN '01' AND '01' AND 
SB2.D_E_L_E_T_ <> '*'
WHERE 
SF2.F2_FILIAL BETWEEN '' AND 'ZZ' AND
SF2.F2_EMISSAO BETWEEN '20090401' AND '20090931' AND 
SF2.F2_CLIENTE = SA1.A1_COD AND 
SF2.D_E_L_E_T_<> '*'
GROUP BY MONTH(SF2.F2_EMISSAO),YEAR(SF2.F2_EMISSAO),SA1.A1_COD , SB1.B1_COD, SB2.B2_LOCAL
ORDER BY MONTH(SF2.F2_EMISSAO),YEAR(SF2.F2_EMISSAO)

