SELECT 
	FILIAL, 
	PROCESSO,
	DATA_PREVISTA,
	CODPROD,
	QUANTIDADE 
FROM 
(
	SELECT	
		CASE 
			W7_FILIAL	WHEN '0401' THEN 'SP-Matriz'
						WHEN '0404' THEN 'SC-Navegantes' 
						ELSE  W7_FILIAL 
		END FILIAL,
		W6.W6_PO_NUM  PROCESSO,
		W6.W6_PRVENTR DATA_PREVISTA,
		W7_COD_I CODPROD, 
		W7_QTDE  QUANTIDADE
	FROM 
		SW6040 W6 WITH(NOLOCK)
		INNER JOIN SW7040 W7 WITH(NOLOCK) ON W7.W7_FILIAL = W6.W6_FILIAL AND W7.W7_HAWB = W6.W6_HAWB AND W7.W7_COD_I = '9921' AND W7.D_E_L_E_T_ = ''
	WHERE	
		W6.W6_PRVENTR > '20210901' AND 
		W6.W6_DT_ENCE = '' AND
		W6.W6_NF_ENT = '' AND
		W6.D_E_L_E_T_ = '' 
	UNION ALL
	SELECT 
		CASE 
			W3_FILIAL WHEN '0401' THEN	'SP-Matriz'
					  WHEN '0404' THEN 'SC-Navegantes' 
			ELSE  W3_FILIAL 
		END FILIAL,
		W5.W5_PO_NUM PROCESSO,
		W3_DT_ENTR MES,
		W3_COD_I CODPROD,
		W5_SALDO_Q QTD 
	FROM 
		SW3040 W3 WITH(NOLOCK)
		INNER JOIN SW5040 W5 WITH(NOLOCK) ON	W5.W5_FILIAL = W3.W3_FILIAL AND W5.W5_COD_I = W3.W3_COD_I AND 
												W5.W5_PO_NUM = W3.W3_PO_NUM AND W5.W5_POSICAO = W3.W3_POSICAO AND 
												W5.W5_SEQ = 0 AND W5.W5_SALDO_Q > 0 AND W5.W5_COD_I = '9921' AND W5.D_E_L_E_T_ = ''
	WHERE 
		W3.W3_DT_ENTR > '20210901' AND
		W3.W3_SEQ = 1 AND
		W3.D_E_L_E_T_ = ''
	UNION ALL 
	SELECT 
		CASE 
			C7_FILIAL	WHEN '0401' THEN 'SP-Matriz'
						WHEN '0404' THEN 'SC-Navegantes' 
						ELSE  C7_FILIAL 
		END FILIAL,
		C7.C7_NUM  PROCESSO,
		C7.C7_DATPRF DATA_PREVISTA,
		C7.C7_PRODUTO CODPROD, 
		C7.C7_QUANT  QUANTIDADE
	FROM 
		SC7040 C7 
	WHERE 
		NOT EXISTS(
			SELECT 
				D1.D1_PEDIDO
			FROM 
				SD1040 D1 
			WHERE 
				D1.D1_FILIAL = C7.C7_FILIAL AND 
				D1.D1_PEDIDO = C7.C7_NUM AND 
				D1.D_E_L_E_T_ = ''
			) AND
		C7.C7_NUMIMP = '' AND 
		C7.C7_PRODUTO = '9921' AND 
		C7.C7_QUJE > 0 AND
		C7.D_E_L_E_T_ = ''
) COMPRAS
ORDER BY 3


--SELECT * FROM SC7040 WHERE C7_FILIAL = '0404' AND D_E_L_E_T_ = ''
--SELECT * FROM SD1040 WHERE D1_FILIAL = '0404' AND D1_COD = '9921' AND D_E_L_E_T_ = ''