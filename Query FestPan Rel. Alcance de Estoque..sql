SELECT SA1.A1_COD, SF2.F2_DOC, SF2.F2_SERIE, 
SD2.D2_QUANT, SD2.D2_ITEM, SD2.D2_DOC, SD2.D2_SERIE, 
SB1.B1_COD, SB1.B1_DESC, SB2.B2_LOCAL, SB2.B2_COD, 
(SB2.B2_QATU - SB2.B2_RESERVA - SB2.B2_QACLASS - SB2.B2_QEMPSA - SB2.B2_QTNP - SB2.B2_QEMPN + SB2.B2_QNPT) AS ESTOQUE
FROM
SA1040 SA1 
INNER JOIN SF2040 SF2 ON SF2.F2_CLIENTE = SA1.A1_COD AND SF2.D_E_L_E_T_ <> '*' 
INNER JOIN SB1040 SB1 ON SB1.B1_COD BETWEEN '' AND 'ZZZZZZ' AND SB1.D_E_L_E_T_ <> '*' 
INNER JOIN SB2040 SB2 ON SB2.B2_FILIAL = SF2.F2_FILIAL AND SB2.B2_COD = SB1.B1_COD AND SB2.B2_LOCAL BETWEEN '  ' AND 'ZZ' AND SB2.D_E_L_E_T_ <> '*'  
INNER JOIN SD2040 SD2 ON SD2.D2_FILIAL = SF2.F2_FILIAL AND SD2.D2_DOC + SD2.D2_SERIE = SF2.F2_DOC + SF2.F2_SERIE AND SD2.D2_COD = SB1.B1_COD AND SD2.D2_TES <> '502' AND  SF2.D_E_L_E_T_ <> '*' 
WHERE 
SA1.A1_COD BETWEEN '     ' AND 'ZZZZZZ' AND 
SF2.F2_EMISSAO BETWEEN '20100101' AND '20101231' AND
SA1.D_E_L_E_T_ <> '*' AND 
SB1.D_E_L_E_T_ <> '*'  
ORDER BY SA1.A1_COD  



